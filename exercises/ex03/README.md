[Home - RAP120](../../README.md)

# Exercise 3: Analyze the ABAP helper class and create ABAP unit tests

## Introduction 

In the previous exercise, you've enhanced the CDS data definition ![datadefinition](images/adt_ddls.png)**`ZR_TRAVEL_###`** with a simply logic and generated its unit tests using **Joule CDS Unit Test Skill**💎 (_see [Exercise 2](../ex02/README.md)_).

In this exercise, you will now analyze the ABAP helper class ![class](images/adt_class.png)**`ZCL_TRAVEL_HELPER_###`** created in [Exercise 1.7](../ex01/README.md/#exercise-16-publish-and-preview-the-travel-app) and create ABAP unit tests for it using **Joule ABAP Unit Test Skill**💎.
 
### Exercises
- [3.1 - Analyze dependencies with Joule ABAP Unit Test Skill](#exercise-31-analyze-dependencies-with-joule-abap-unit-test-skill)
- [3.2 - Define the ABAP unit test class](#exercise-32-define-the-abap-unit-test-class)
- [3.3 - Generate test doubles with Joule ABAP Unit Test Skill ](#exercise-33-generate-test-doubles-with-joule-abap-unit-test-skill)
- [3.4 - Add unit test with Joule Predictive Code Completion](exercise-34-add-unit-test-with-joule-predictive-code-completion)
- [Summary & Next Exercise](#summary--next-exercise)


## Exercise 3.1: Analyze dependencies with Joule ABAP Unit Test Skill💎
[^Top of page](#Introduction)

>  Analyze the ABAP helper class ![class](images/adt_class.png)**`ZCL_TRAVEL_HELPER_###`**. 
>  
> Understanding class dependencies is essential for identifying unstable dependencies, such as those involving databases or other APIs. These test-unfriendly dependencies may return unexpected test results depending on systems, users, or other aspects in your code. Therefore, it's useful to replace test-unfriendly dependencies with test doubles to enhance the stability of your tests.
> 
> ℹ️ **Info**: To access the Joule copilot, click on the magnifier icon in the toolbar and type **_Joule_**.  
>
>    ![](/exercises/ex03/images/adt_open_joule.png)

<details>
  <summary>🔵Click to expand!</summary>
  <br>
  
   1. Open the class **`ZCL_TRAVEL_HELPER_###`** and open Joule copilot by clicking on the magnifier icon in the ADT toolbar and typing **_Joule_** in the command field. 
 
      ![](/exercises/ex03/images/adt_open_joule.png)
 
   2. From the Joule copilot, click on **`@`** and select **`@aunit`**. Then, press **Enter** to start the **ABAP Unit assistant**.   
      Then, press **Start**.

   3. Press on _**Find Test-Unfriendly Dependencies**_ to start the analysis.

   4. As you can see, ![class](images/adt_class.png)**`ZCL_TRAVEL_HELPER_###`** has one dependency with the database table ![table](images/adt_tabl.png)**`/DMO/CUSTOMER`**. 

      ![](/exercises/ex03/images/3_2_analyze_dependencies.gif)
 
</details>

## Exercise 3.2: Define the ABAP unit test class
[^Top of page](#Introduction)

> Define the unit test class ![class](images/adt_class.png)**`LTCL_TRAVEL_HELPER_###`**.

<details>
  <summary>🔵Click to expand!</summary>

   1. Go to the **Test Clasess** tab at the bottom of class editor and insert a template for ABAP Unit test classes.
 
      To do that, just type **`testClass`** in your editor, then press **Ctrl + Space** to open the code completion list. 
 
      Select **`testClass - Test class (ABAP Unit)`** from the suggested template entries.

   2. Now change the default local test class name to **`LTCL_TRAVEL_HELPER_###`**.
 
   3. Delete the default method **`first_test`** from the definition and implementation sections. 
 
   4. Save![save icon](images/adt_save.png) and activate![activate icon](images/adt_activate.png) the changes.

      ![](/exercises/ex03/images/3_3_testClass.gif)

</details>


## Exercise 3.3: Generate test doubles with Joule ABAP Unit Test Skill💎
[^Top of page](#Introduction)

> After identifying test-unfriendly dependencies in the code to test, isolate these dependencies in your test class by replacing them with test doubles to improve the stability of unit test results. 
> By substituting calls to database tables or APIs with test doubles, you ensure that your unit tests remain stable and predictable, regardless of the system you're working on.
> 
> ⚠ **Warning regarding Joule's outputs** ⚠    
> Please be aware that the outputs generated by Joule in this exercise description may differ from yours, and the provided code snippets should be adjusted accordingly. **Always review the code generated by Joule**.

<details>
  <summary>🔵Click to expand!</summary>
  <br>

  1. Go to the **Global Class** tab at the bottom of editor and position the cursor on the database table name **`/DMO/CUSTOMER`** in the `SELECT FROM` statement. 
 
  2. Press **Ctrl + 1** (Windows) or **Cmd + 1** (Mac) to start the **Quick Assist view** and select the entry **`Isolate database table /dmo/customer`** to have Joule generate the test doubles. 
 
  3. Review the generated code in Joule copilot and press **Copy**. 
 
  4. Switch to the **Test Clasess** tab and replace the current source code with the one copied from the Joule view.
 
  5. Save![save icon](images/adt_save.png) and activate![activate icon](images/adt_activate.png) the changes.

     ![](/exercises/ex03/images/3_4_testDouble.gif)
 
</details>

## Exercise 3.4: Add unit test with Joule Predictive Code Completion💎
[^Top of page](#Introduction)

> Now utilize **Joule Predictive Code Completion**💎 to assist you in developing unit test logic.
>  
> ⚠ **Warning regarding Joule's outputs** ⚠   
> Please be aware that the outputs generated by Joule in this exercise description may differ from yours, and the provided code snippets should be adjusted accordingly. **Always review the code generated by Joule**.

<details>
  <summary>🔵 Click to expand!</summary>
  <br>

  1. Add the method interface **``** in the definition section:

     ```ABAP
     test_validate_customer_success FOR TESTING. 
     ```

  2. Add **`test_validate_customer_success`** implementation using ADT Quick Fix. 
 
  3. Press **Enter**. Joule will suggest the unit test code. 
 
     > ℹ️ **Hint**: You can toggle the **Joule Predictive Code Completion** in the toolbar ![](/exercises/images/adt_joule_code_completion2.png)
 
  4. Review the code and press _**Tab**_
 
  5. Save![save icon](images/adt_save.png) and activate![activate icon](images/adt_activate.png) the changes.
 
  6. Run the unit tests.

     The test class ![abapclass](images/adt_class.png)**`LTCL_TRAVEL_HELPER_###`** should look like this:

     ```ABAP
     CLASS ltcl_travel_helper_### DEFINITION FINAL FOR TESTING
       DURATION SHORT RISK LEVEL HARMLESS.

       PRIVATE SECTION.
         "! ABAP SQL test environment
         CLASS-DATA environment TYPE REF TO if_osql_test_environment.
         CLASS-METHODS:
           "setup test double framework
           class_setup,
           "stop test doubles
           class_teardown.

         METHODS:
           "rollback test doubles
           setup,

           "! Test helper method
           configure_db_testdoubles,

           test_validate_customer_success for testing.

     ENDCLASS.

     CLASS ltcl_travel_helper_### IMPLEMENTATION.

       METHOD class_setup.
         "setup test double framework
         environment = cl_osql_test_environment=>create(
           i_dependency_list = VALUE #( ( '/DMO/CUSTOMER' ) ) ).
       ENDMETHOD.

       METHOD class_teardown.
         "stop the test doubles
         environment->destroy( ).
       ENDMETHOD.

       METHOD setup.
         "clear the content of the test doubles per test
         environment->clear_doubles( ).
         configure_db_testdoubles( ).
       ENDMETHOD.

       METHOD configure_db_testdoubles.
         DATA customer_stub_data TYPE STANDARD TABLE OF /dmo/customer.

         customer_stub_data = VALUE #(
           ( client = '100' customer_id = '000001' )
           ( client = '100' customer_id = '000002' )
           ( client = '100' customer_id = '000003' )
         ).
         environment->insert_test_data( customer_stub_data ).
       ENDMETHOD.

       METHOD test_validate_customer_success.
         DATA(cut) = NEW zcl_travel_helper_000( ).
         DATA(result) = cut->validate_customer( '000001' ).

         cl_abap_unit_assert=>assert_equals( exp = abap_true act = result ).
       ENDMETHOD.

     ENDCLASS.
     ```

  7. You can try to implement the unit test **`test_validate_customer_failure`** following the same steps.

     ![](/exercises/ex03/images/3_5_unitTest.gif)

</details>


## Summary & Next Exercise
[^Top of page](#Introduction)

Now that you've... 
- analyzed test-unfriendly dependencies with **Joule ABAP Unit Skill**,
- generated test doubles to replace dependencies to other development objects and increases the stability of your unit test results with **Joule ABAP Unit Skill**, and
- added a new unit test with **Joule Predictive Code Completion**,

you can continue with the next exercise – **[Exercise 4: Add a validation](../ex04/README.md)**

---

